# 事件跟踪参考手册

本文完全由人工编写，没有机器人参与🤖  
IP属地：生化斯坦
---

**版本**: 0.0.3-a  
**最后更新**: 2026-02-20  

## 概述

FaGe.Kcp 使用 `System.Diagnostics.Tracing.EventSource` 提供丰富的诊断信息，帮助开发者监控 KCP 连接状态、调试协议行为、分析性能问题。事件源名称为 `"FaGe.Kcp"`，GUID 为 `762347F4-61D5-4F4E-AA18-C3CA84F725B6`。所有事件均可通过 ETW (Windows)、LTTng (Linux) 或 `dotnet-trace` 等工具收集。

本文档详细列出了所有事件及其含义、参数和诊断价值。

## 启用事件收集

### 使用 dotnet-trace
```bash
dotnet trace collect --providers FaGe.Kcp:0xFFFFFFFF:4
```

### 使用 PerfView
1. 打开 PerfView
2. 选择 **Collect** → **Providers**
3. 添加 Provider `FaGe.Kcp`，Keywords 可根据需要选择（例如 `0xFFFFFFFF` 启用所有事件）
4. 开始收集

## 事件分类

事件按功能可分为以下几类（事件ID可能分散，但逻辑上分组）：

- **API 调用事件** (ID 1-7, 21-22)：记录应用层调用结果、连接生命周期和配置变更。
- **内部协议事件** (ID 8-15, 20)：记录协议内部细节，如收到 ACK/PUSH、窗口探测、死链接等。
- **拥塞控制事件** (ID 16-18)：记录 RTT、拥塞窗口变化、快速重传。
- **缓冲池事件** (ID 23-25)：记录缓冲区租赁/回收，用于诊断内存使用。

---

## 事件详细说明

### ID 1: KcpInputResult
**级别**: Informational  
**关键词**: Api  
**触发时机**: 当 `InputFromUnderlyingTransport` 处理完一批数据后触发（仅一次，无论处理多少个包）。  
**参数**:
| 名称 | 类型 | 描述 |
|------|------|------|
| rawResult | int | 处理结果码：0=成功，-1=格式错误，-2=conv不匹配，-3=未知命令 |
| connectionId | uint | 连接标识符 |
**诊断价值**: 连续出现非0值表示网络传输异常或对端行为异常。

### ID 2: KcpReceiveFailed
**级别**: Informational  
**关键词**: Api  
**触发时机**: 应用层调用 `TryReadPacket` 但无完整消息可读时。  
**参数**:
| 名称 | 类型 | 描述 |
|------|------|------|
| rawResult | int | 失败码：0=队列空，-2=分片未完整 |
| connectionId | uint | 连接标识符 |
**诊断价值**: 频繁出现0可能读取过快；出现-2表示大消息丢包或分片未到齐。

### ID 3: KcpUpdateBegin
**级别**: Informational  
**关键词**: Api  
**触发时机**: `Update` 方法被调用时。  
**参数**:
| 名称 | 类型 | 描述 |
|------|------|------|
| connectionId | uint | 连接标识符 |
| timeticks | uint | 当前时间戳（毫秒） |
**诊断价值**: 可追踪更新频率，结合其他事件分析时钟同步问题。

### ID 4: KcpFlush
**级别**: Informational  
**关键词**: Api  
**触发时机**: `FlushAsync` 开始执行时。  
**参数**:
| 名称 | 类型 | 描述 |
|------|------|------|
| connectionId | uint | 连接标识符 |
**诊断价值**: 记录刷新操作频率，帮助分析吞吐量。

### ID 5: KcpSendEnd
**级别**: Informational  
**关键词**: Api  
**触发时机**: `QueueToSenderWithAsyncSource` 完成数据排队后（无论成功与否）。  
**参数**:
| 名称 | 类型 | 描述 |
|------|------|------|
| connectionId | uint | 连接标识符 |
| length | int | 实际排队的字节数 |
| rawErrorCode | int | 0=成功，其他=错误码 |
**诊断价值**: 确认数据已进入发送队列，`length` 可能小于请求长度（流模式追加时）。

### ID 6: KcpReceived
**级别**: Informational  
**关键词**: Api  
**触发时机**: `TryReadPacket` 成功组装一个完整应用层消息时。  
**参数**:
| 名称 | 类型 | 描述 |
|------|------|------|
| connectionId | uint | 连接标识符 |
| length | int | 消息总长度（字节） |
**诊断价值**: 统计接收数据量，确认消息已交付上层。

### ID 7: KcpOutputBegin
**级别**: Informational  
**关键词**: Api  
**触发时机**: 调用 `InvokeOutputCallbackAsync` 发送数据前。  
**参数**:
| 名称 | 类型 | 描述 |
|------|------|------|
| connectionId | uint | 连接标识符 |
| length | int | 即将发送的数据长度 |
**诊断价值**: 监控底层数据发送量，结合网络统计可分析发送效率。

### ID 8: KcpHeaderWasRead
**级别**: Verbose  
**关键词**: Internal  
**触发时机**: 解析每个入站数据包头部时。  
**参数**:
| 名称 | 类型 | 描述 |
|------|------|------|
| connectionId | uint | 连接标识符 |
| conv | uint | 会话ID |
| cmd | uint | 命令类型 |
| frg | uint | 分片序号 |
| wnd | uint | 窗口大小 |
| ts | uint | 时间戳 |
| sn | uint | 序列号 |
| una | uint | 未确认序号 |
| length | uint | 数据长度 |
**诊断价值**: 捕获所有入站包头部，用于深入协议分析，建议仅在调试时启用。

### ID 9: KcpProbeReceived
**级别**: Informational  
**关键词**: Internal  
**触发时机**: 收到窗口探测包（`IKCP_CMD_WASK`）时。  
**参数**:
| 名称 | 类型 | 描述 |
|------|------|------|
| connectionId | uint | 连接标识符 |
**诊断价值**: 对端正在探测我方窗口大小，可能因我方窗口满或网络拥塞。

### ID 10: KcpWindowTold
**级别**: Informational  
**关键词**: Internal  
**触发时机**: 收到窗口告知包（`IKCP_CMD_WINS`）时。  
**参数**:
| 名称 | 类型 | 描述 |
|------|------|------|
| connectionId | uint | 连接标识符 |
| wnd | uint | 对端窗口大小 |
**诊断价值**: 了解对端接收窗口，帮助分析流量控制行为。

### ID 11: KcpRemoteAckReceived
**级别**: Verbose  
**关键词**: Internal  
**触发时机**: 收到 ACK 包时。  
**参数**:
| 名称 | 类型 | 描述 |
|------|------|------|
| connectionId | uint | 连接标识符 |
| sn | uint | 被确认的序列号 |
| ts | uint | 时间戳 |
**诊断价值**: 跟踪 ACK 到达情况，计算 RTT 或检测丢包。

### ID 12: KcpRemotePushReceived
**级别**: Verbose  
**关键词**: Internal  
**触发时机**: 收到 PUSH 数据包时。  
**参数**:
| 名称 | 类型 | 描述 |
|------|------|------|
| connectionId | uint | 连接标识符 |
| sn | uint | 数据包序列号 |
| ts | uint | 时间戳 |
| length | uint | 数据长度 |
**诊断价值**: 监控数据包到达情况，结合窗口状态分析流量。

### ID 13: KcpFlushBufferNotEnough
**级别**: Warning  
**关键词**: Internal  
**触发时机**: 刷新缓冲区空间不足以容纳下一个待发送包，需要提前输出并重置缓冲区时。  
**参数**:
| 名称 | 类型 | 描述 |
|------|------|------|
| connectionId | uint | 连接标识符 |
| mtu | uint | 当前MTU |
| sn | uint | 当前待发送包的序列号 |
| xmit | uint | 该包已重传次数 |
| encodedLength | int | 已编码数据长度 |
| neededLength | int | 需要的数据长度 |
| bufferSizeLimit | int | 缓冲区大小限制 |
**诊断价值**: 帮助分析 MTU 配置是否过小，或缓冲区策略是否需要调整。

### ID 14: KcpEmittingSinglePushPacket
**级别**: Verbose  
**关键词**: Internal | NeedSend  
**触发时机**: 实际发送（或重传）一个数据包时。  
**参数**:
| 名称 | 类型 | 描述 |
|------|------|------|
| conv | uint | 连接标识符 |
| length | int | 包数据长度 |
| sn | uint | 序列号 |
| frg | byte | 分片序号 |
| wnd | ushort | 当前窗口大小 |
| una | uint | 未确认序号 |
**诊断价值**: 记录每个发出的数据包，可用于计算发送速率、检测重传。

### ID 15: KcpDeadLink
**级别**: Error  
**关键词**: Internal | DeadLink  
**触发时机**: 某包重传次数达到 `dead_link` 上限，连接将被关闭。  
**参数**:
| 名称 | 类型 | 描述 |
|------|------|------|
| conv | uint | 连接标识符 |
| xmit | uint | 实际重传次数 |
| dead_link | uint | 最大重传阈值 |
**诊断价值**: 严重错误，表示连接因丢包过多而断开，需检查网络状况。

### ID 16: KcpCongestionWindowChange
**级别**: Verbose  
**关键词**: Internal  
**触发时机**: 拥塞窗口（cwnd）或慢启动阈值（ssthresh）发生变化时。  
**参数**:
| 名称 | 类型 | 描述 |
|------|------|------|
| connectionId | uint | 连接标识符 |
| cwnd | uint | 当前拥塞窗口 |
| ssthresh | uint | 慢启动阈值 |
| incr | uint | 增量值（用于计算） |
**诊断价值**: 分析拥塞控制行为，判断是否发生拥塞。

### ID 17: KcpFastRetransmit
**级别**: Verbose  
**关键词**: Internal  
**触发时机**: 触发快速重传时。  
**参数**:
| 名称 | 类型 | 描述 |
|------|------|------|
| connectionId | uint | 连接标识符 |
| sn | uint | 被快速重传的包序号 |
| fastack | uint | 收到的重复ACK计数 |
| resent | uint | 快速重传阈值 |
**诊断价值**: 指示网络丢包（乱序）触发快速重传，帮助区分丢包与乱序。

### ID 18: KcpRttUpdated
**级别**: Verbose  
**关键词**: Internal  
**触发时机**: RTT 测量值更新时。  
**参数**:
| 名称 | 类型 | 描述 |
|------|------|------|
| connectionId | uint | 连接标识符 |
| rtt | int | 本次测量的 RTT（毫秒） |
| rto | uint | 更新后的超时重传时间 |
**诊断价值**: 监控网络延迟变化，用于调整 RTO 算法。

### ID 19: KcpWindowFullStateChange
**级别**: Informational  
**关键词**: Internal  
**触发时机**: 接收窗口从非满变为满，或从满变为非满时。  
**参数**:
| 名称 | 类型 | 描述 |
|------|------|------|
| connectionId | uint | 连接标识符 |
| isFull | bool | 是否已满 |
| rcvWnd | uint | 当前接收窗口大小 |
| totalPackets | uint | 接收队列+缓冲区中的包总数 |
| effectiveWindow | uint | 有效窗口（`Min(rcv_wnd, maxRcvWindow)`） |
**诊断价值**: 监控接收窗口状态，满窗口可能导致对端暂停发送。

### ID 20: KcpFragmentReassembled
**级别**: Verbose  
**关键词**: Internal  
**触发时机**: 在分片数据包加入发送队列时触发（记录分片信息）。  
**参数**:
| 名称 | 类型 | 描述 |
|------|------|------|
| connectionId | uint | 连接标识符 |
| sn | uint | 包序列号 |
| totalFragments | int | 总分片数 |
| currentFragment | byte | 当前分片序号 |
| isStreamMode | bool | 是否流模式 |
**诊断价值**: 跟踪大消息的分片情况，流模式下分片序号可能递减。

### ID 21: KcpConnectionDisposed
**级别**: Informational  
**关键词**: Api  
**触发时机**: 连接对象被释放（`Dispose`）时。  
**参数**:
| 名称 | 类型 | 描述 |
|------|------|------|
| connectionId | uint | 连接标识符 |
**诊断价值**: 记录连接生命周期结束，帮助追踪资源泄漏。

### ID 22: KcpNoDelayChanged
**级别**: Informational  
**关键词**: Api  
**触发时机**: `ConfigureNoDelay` 被调用且参数变化时。  
**参数**:
| 名称 | 类型 | 描述 |
|------|------|------|
| conv | uint | 连接标识符 |
| nodelay | bool | 是否无延迟模式 |
| interval | int | 刷新间隔 |
| resend | int | 快速重传阈值 |
| nc | bool | 是否禁用拥塞控制 |
**诊断价值**: 记录配置变更，便于复现特定行为。

### ID 23: KcpBufferWasRent
**级别**: Verbose  
**关键词**: Internal | Buffer  
**触发时机**: 从数组池租赁缓冲区时。  
**参数**:
| 名称 | 类型 | 描述 |
|------|------|------|
| oldsize | int | 原缓冲区大小 |
| requiredSize | int | 请求的大小 |
| actualCapacity | int | 实际获得的大小 |
**诊断价值**: 监控缓冲区租赁情况，分析内存使用模式。

### ID 24: KcpBufferWasReturned
**级别**: Verbose  
**关键词**: Internal | Buffer  
**触发时机**: 缓冲区归还到池时。  
**参数**:
| 名称 | 类型 | 描述 |
|------|------|------|
| capacity | int | 缓冲区容量 |
**诊断价值**: 与租赁事件配合，检测内存泄漏或频繁分配。

### ID 25: KcpPacketBufferWantBuffer
**级别**: Verbose  
**关键词**: Internal | Buffer  
**触发时机**: `PacketBuffer` 使用缓冲区前。  
**参数**:
| 名称 | 类型 | 描述 |
|------|------|------|
| connectionId | uint | 连接标识符 |
| requiredSize | int | 需要的大小 |
**诊断价值**: 帮助分析数据包大小分布，判断是否需要调整 MTU 或初始缓冲区大小。

---

## 常见诊断场景

### 1. 分析丢包和重传
启用 Keywords `Internal` 和 `NeedSend`，关注：
- `KcpFastRetransmit` (17)：快速重传
- `KcpEmittingSinglePushPacket` (14)：每次发送（包括重传）
- `KcpDeadLink` (15)：死链接

### 2. 监控窗口状态与流量控制
启用 Keywords `Internal`，关注：
- `KcpWindowFullStateChange` (19)：窗口满事件
- `KcpWindowTold` (10)：对端窗口告知
- `KcpCongestionWindowChange` (16)：拥塞窗口变化

### 3. 调试协议交互
启用 Keywords `Internal`（Verbose 级别），可捕获所有入站包头 `KcpHeaderWasRead` (8) 和出站包 `KcpEmittingSinglePushPacket` (14)。

### 4. 检查内存使用
启用 Keywords `Buffer`，关注 `KcpBufferWasRent` (23) 和 `KcpBufferWasReturned` (24)，若租赁和归还不平衡可能存在内存泄漏。

---

## 注意事项

- **事件编号与分类无关**：早期设计原因，事件 ID 不严格按分类连续，请以 Keywords 为分组依据。
- **Verbose 级别事件**：可能非常频繁，建议仅在诊断时启用，以免影响性能。
- **向后兼容**：已发布的版本中事件 ID 不会变更，新增事件会使用新的 ID。

---

## 版本历史

| 版本 | 日期       | 变更说明 |
|------|------------|----------|
| 0.0.3-a  | 2026-02-20 | 初始文档，涵盖所有 1-25 事件 |

---

如有疑问或需要进一步帮助，请参考源代码或联系维护者。